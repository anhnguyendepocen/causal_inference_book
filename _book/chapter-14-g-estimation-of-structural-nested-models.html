<!DOCTYPE html>
<html >

<head>

  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>4 Chapter 14: G-Estimation of Structural Nested Models | Coding Causal Inference in R</title>
  <meta name="description" content="4 Chapter 14: G-Estimation of Structural Nested Models | Coding Causal Inference in R">
  <meta name="generator" content="bookdown  and GitBook 2.6.7">

  <meta property="og:title" content="4 Chapter 14: G-Estimation of Structural Nested Models | Coding Causal Inference in R" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="4 Chapter 14: G-Estimation of Structural Nested Models | Coding Causal Inference in R" />
  
  
  



<meta name="date" content="2019-04-16">

  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  
  
<link rel="prev" href="chapter-13.html">
<link rel="next" href="chapter-15.html">
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />









<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Causal Inference Notebook</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About</a></li>
<li class="chapter" data-level="1" data-path="chapter-11-why-model.html"><a href="chapter-11-why-model.html"><i class="fa fa-check"></i><b>1</b> Chapter 11: Why model?</a><ul>
<li class="chapter" data-level="1.1" data-path="chapter-11-why-model.html"><a href="chapter-11-why-model.html#program-11.1"><i class="fa fa-check"></i><b>1.1</b> Program 11.1</a></li>
<li class="chapter" data-level="1.2" data-path="chapter-11-why-model.html"><a href="chapter-11-why-model.html#program-11.2"><i class="fa fa-check"></i><b>1.2</b> Program 11.2</a></li>
<li class="chapter" data-level="1.3" data-path="chapter-11-why-model.html"><a href="chapter-11-why-model.html#program-11.3"><i class="fa fa-check"></i><b>1.3</b> Program 11.3</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="chapter-12-ip-weighting-and-marginal-structural-models.html"><a href="chapter-12-ip-weighting-and-marginal-structural-models.html"><i class="fa fa-check"></i><b>2</b> Chapter 12: IP Weighting and Marginal Structural Models</a><ul>
<li class="chapter" data-level="2.1" data-path="chapter-12-ip-weighting-and-marginal-structural-models.html"><a href="chapter-12-ip-weighting-and-marginal-structural-models.html#program-12.1"><i class="fa fa-check"></i><b>2.1</b> Program 12.1</a></li>
<li class="chapter" data-level="2.2" data-path="chapter-12-ip-weighting-and-marginal-structural-models.html"><a href="chapter-12-ip-weighting-and-marginal-structural-models.html#program-12.2"><i class="fa fa-check"></i><b>2.2</b> Program 12.2</a></li>
<li class="chapter" data-level="2.3" data-path="chapter-12-ip-weighting-and-marginal-structural-models.html"><a href="chapter-12-ip-weighting-and-marginal-structural-models.html#program-12.3"><i class="fa fa-check"></i><b>2.3</b> Program 12.3</a></li>
<li class="chapter" data-level="2.4" data-path="chapter-12-ip-weighting-and-marginal-structural-models.html"><a href="chapter-12-ip-weighting-and-marginal-structural-models.html#program-12.4"><i class="fa fa-check"></i><b>2.4</b> Program 12.4</a></li>
<li class="chapter" data-level="2.5" data-path="chapter-12-ip-weighting-and-marginal-structural-models.html"><a href="chapter-12-ip-weighting-and-marginal-structural-models.html#program-12.5"><i class="fa fa-check"></i><b>2.5</b> Program 12.5</a></li>
<li class="chapter" data-level="2.6" data-path="chapter-12-ip-weighting-and-marginal-structural-models.html"><a href="chapter-12-ip-weighting-and-marginal-structural-models.html#program-12.6"><i class="fa fa-check"></i><b>2.6</b> Program 12.6</a></li>
<li class="chapter" data-level="2.7" data-path="chapter-12-ip-weighting-and-marginal-structural-models.html"><a href="chapter-12-ip-weighting-and-marginal-structural-models.html#program-12.7"><i class="fa fa-check"></i><b>2.7</b> Program 12.7</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="chapter-13.html"><a href="chapter-13.html"><i class="fa fa-check"></i><b>3</b> Chapter 13</a></li>
<li class="chapter" data-level="4" data-path="chapter-14-g-estimation-of-structural-nested-models.html"><a href="chapter-14-g-estimation-of-structural-nested-models.html"><i class="fa fa-check"></i><b>4</b> Chapter 14: G-Estimation of Structural Nested Models</a><ul>
<li class="chapter" data-level="4.1" data-path="chapter-14-g-estimation-of-structural-nested-models.html"><a href="chapter-14-g-estimation-of-structural-nested-models.html#program-14.1"><i class="fa fa-check"></i><b>4.1</b> Program 14.1</a></li>
<li class="chapter" data-level="4.2" data-path="chapter-14-g-estimation-of-structural-nested-models.html"><a href="chapter-14-g-estimation-of-structural-nested-models.html#program-14.2"><i class="fa fa-check"></i><b>4.2</b> Program 14.2</a></li>
<li class="chapter" data-level="4.3" data-path="chapter-14-g-estimation-of-structural-nested-models.html"><a href="chapter-14-g-estimation-of-structural-nested-models.html#program-14.3"><i class="fa fa-check"></i><b>4.3</b> Program 14.3</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="chapter-15.html"><a href="chapter-15.html"><i class="fa fa-check"></i><b>5</b> Chapter 15</a></li>
<li class="chapter" data-level="6" data-path="chapter-16.html"><a href="chapter-16.html"><i class="fa fa-check"></i><b>6</b> Chapter 16</a></li>
<li class="chapter" data-level="7" data-path="chapter-17.html"><a href="chapter-17.html"><i class="fa fa-check"></i><b>7</b> Chapter 17</a></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Coding Causal Inference in R</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="chapter-14-g-estimation-of-structural-nested-models" class="section level1">
<h1><span class="header-section-number">4</span> Chapter 14: G-Estimation of Structural Nested Models</h1>
<p>This is the code for Chapter 14.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(broom)
<span class="kw">library</span>(geepack)
<span class="kw">library</span>(boot)
<span class="kw">library</span>(cidata)</code></pre>
<div id="program-14.1" class="section level2">
<h2><span class="header-section-number">4.1</span> Program 14.1</h2>
<p>In this section, Hernán and Robins discuss rank preservation: that participants would be ranked in the same order for all counterfactual outcomes. We can’t do that, but we can look at the observed ranks. There are many ways to make ranks, but we’ll use <code>dplyr::min_rank()</code> and rank the participants in descending order of weights.</p>
<pre class="sourceCode r"><code class="sourceCode r">ranks &lt;-<span class="st"> </span>nhefs <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">rank =</span> <span class="kw">min_rank</span>(<span class="kw">desc</span>(wt82_<span class="dv">71</span>)), 
    <span class="dt">lbl =</span> <span class="kw">if_else</span>(
      rank <span class="op">&lt;=</span><span class="st"> </span><span class="dv">3</span> <span class="op">|</span><span class="st"> </span>rank <span class="op">&gt;=</span><span class="st"> </span>(<span class="kw">max</span>(rank, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>) <span class="op">-</span><span class="st"> </span><span class="dv">2</span>),
      <span class="kw">round</span>(wt82_<span class="dv">71</span>, <span class="dv">1</span>),
      <span class="ot">NA_real_</span>
    )
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(seqn, rank, lbl, wt82_<span class="dv">71</span>)

ranks <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>lbl) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">top_n</span>(<span class="dv">5</span>, wt82_<span class="dv">71</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>()</code></pre>
<table>
<thead>
<tr class="header">
<th align="right">seqn</th>
<th align="right">rank</th>
<th align="right">wt82_71</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1769</td>
<td align="right">3</td>
<td align="right">37.65051</td>
</tr>
<tr class="even">
<td align="right">5415</td>
<td align="right">5</td>
<td align="right">34.01780</td>
</tr>
<tr class="odd">
<td align="right">6928</td>
<td align="right">2</td>
<td align="right">47.51130</td>
</tr>
<tr class="even">
<td align="right">22342</td>
<td align="right">4</td>
<td align="right">36.96925</td>
</tr>
<tr class="odd">
<td align="right">23522</td>
<td align="right">1</td>
<td align="right">48.53839</td>
</tr>
</tbody>
</table>
<pre class="sourceCode r"><code class="sourceCode r">ranks <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>lbl) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">top_n</span>(<span class="op">-</span><span class="dv">5</span>, wt82_<span class="dv">71</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span>knitr<span class="op">::</span><span class="kw">kable</span>()</code></pre>
<table>
<thead>
<tr class="header">
<th align="right">seqn</th>
<th align="right">rank</th>
<th align="right">wt82_71</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">5412</td>
<td align="right">1563</td>
<td align="right">-29.02579</td>
</tr>
<tr class="even">
<td align="right">13593</td>
<td align="right">1565</td>
<td align="right">-30.50192</td>
</tr>
<tr class="odd">
<td align="right">21897</td>
<td align="right">1562</td>
<td align="right">-25.97056</td>
</tr>
<tr class="even">
<td align="right">23321</td>
<td align="right">1566</td>
<td align="right">-41.28047</td>
</tr>
<tr class="odd">
<td align="right">24363</td>
<td align="right">1564</td>
<td align="right">-30.05007</td>
</tr>
</tbody>
</table>
<p>It’s easier to understand how the ranks are distributed in a plot. The heart of this plot is simply plotting the ranks (on the <code>y</code> axis) versus the observed change in weights. We’ll also label the top and bottom 3 ranks with <code>geom_text_repel()</code> from the <code>ggrepel</code> package. The people with the most weight loss are on the left while people with the most weight gain are on the right.</p>
<pre class="sourceCode r"><code class="sourceCode r">ranks <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">y =</span> rank, <span class="dt">x =</span> wt82_<span class="dv">71</span>)) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">0</span>, <span class="dt">col =</span> <span class="st">&quot;grey90&quot;</span>, <span class="dt">size =</span> <span class="fl">1.3</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">col =</span> <span class="st">&quot;#0072B2&quot;</span>, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">alpha =</span> <span class="fl">.9</span>) <span class="op">+</span>
<span class="st">    </span>ggrepel<span class="op">::</span><span class="kw">geom_text_repel</span>(
      <span class="kw">aes</span>(<span class="dt">label =</span> lbl), 
      <span class="dt">size =</span> <span class="dv">4</span>,
      <span class="dt">point.padding =</span> <span class="fl">0.1</span>, 
      <span class="dt">box.padding =</span> <span class="fl">.6</span>, 
      <span class="dt">force =</span> <span class="fl">1.</span>,
      <span class="dt">min.segment.length =</span> <span class="dv">0</span>, 
      <span class="dt">seed =</span> <span class="dv">777</span>
    ) <span class="op">+</span>
<span class="st">    </span><span class="kw">theme_minimal</span>(<span class="dv">14</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw">expand_limits</span>(<span class="dt">y =</span> <span class="kw">c</span>(<span class="op">-</span><span class="dv">200</span>, <span class="dv">1700</span>)) <span class="op">+</span>
<span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;change in weight&quot;</span>)</code></pre>
<p><img src="causal_inference_book_files/figure-html/unnamed-chunk-41-1.png" width="672" /></p>
</div>
<div id="program-14.2" class="section level2">
<h2><span class="header-section-number">4.2</span> Program 14.2</h2>
<p>We’ll start by quickly making censoring weights for the complete data set, <code>nhefs_complete</code>, as in Chapter 12.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co">#  compute unstabilized inverse probability of censoring weights</span>
cwts_model &lt;-<span class="st"> </span><span class="kw">glm</span>(
  censored <span class="op">~</span><span class="st"> </span>qsmk <span class="op">+</span><span class="st"> </span>sex <span class="op">+</span><span class="st"> </span>race <span class="op">+</span><span class="st"> </span>age <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(age<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>education <span class="op">+</span><span class="st"> </span>
<span class="st">  </span>smokeintensity <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(smokeintensity<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">  </span>smokeyrs <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(smokeyrs<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>exercise <span class="op">+</span><span class="st"> </span>active <span class="op">+</span><span class="st"> </span>
<span class="st">  </span>wt71 <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(wt71<span class="op">^</span><span class="dv">2</span>), 
  <span class="dt">data =</span> nhefs_complete, <span class="dt">family =</span> <span class="kw">binomial</span>()
)

nhefs_complete &lt;-<span class="st"> </span>cwts_model <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">augment</span>(<span class="dt">type.predict =</span> <span class="st">&quot;response&quot;</span>, <span class="dt">data =</span> nhefs_complete) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">cwts =</span> <span class="dv">1</span> <span class="op">/</span><span class="st"> </span><span class="kw">ifelse</span>(censored <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="dv">1</span> <span class="op">-</span><span class="st"> </span>.fitted, .fitted))</code></pre>
<p>G-Estimation looks quite different than other types of causal regression models. Our main effect is not for <code>wt82_71</code> but <code>h_psi</code>. Our goal is to find the regression model that minimizes <code>h_psi</code> so that it is independent of the outcome; we want it as close to the null as possible. <code>h_psi</code> is defined as the outcome minus the product of <code>psi</code> and the exposure. Then, we include <code>h_psi</code> in a model with the <em>exposure</em> as the outcome (<code>qsmk</code>) weighted by our censoring weights and adjusted for the confounders we’ve used in previous models. We’ll write a function, <code>compute_h_psi()</code>, to compute <code>h_psi</code> for a given value of <code>psi</code>.</p>
<p>In the book, Hernán and Robins tell us the best fit is 3.446, so we’ll test that the G-estimation model gives us a number very close to 0. The interpretation for this estimate is similar to the other causal modeling approaches: if everyone had quit smoking, they would have gained 3.446 more than if everyone had kept smoking.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># compute all values of h(psi)</span>
compute_h_psi &lt;-<span class="st"> </span><span class="cf">function</span>(psi) {
  df &lt;-<span class="st"> </span>nhefs_complete <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">h_psi =</span> wt82_<span class="dv">71</span> <span class="op">-</span><span class="st"> </span>psi <span class="op">*</span><span class="st"> </span>qsmk) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="co"># gee doesn&#39;t like missing values</span>
<span class="st">    </span><span class="kw">drop_na</span>(h_psi)
  
  <span class="kw">geeglm</span>(
    qsmk <span class="op">~</span><span class="st"> </span>h_psi <span class="op">+</span><span class="st"> </span>sex <span class="op">+</span><span class="st"> </span>race <span class="op">+</span><span class="st"> </span>age <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(age<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>education <span class="op">+</span><span class="st"> </span>
<span class="st">      </span>smokeintensity <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(smokeintensity<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">      </span>smokeyrs <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(smokeyrs<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>exercise <span class="op">+</span><span class="st"> </span>active <span class="op">+</span><span class="st"> </span>
<span class="st">      </span>wt71 <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(wt71<span class="op">^</span><span class="dv">2</span>), 
    <span class="dt">data =</span> df, 
    <span class="dt">family =</span> <span class="kw">binomial</span>(),
    <span class="dt">std.err =</span> <span class="st">&quot;san.se&quot;</span>,
    <span class="dt">weights =</span> cwts, 
    <span class="dt">id =</span> id, 
    <span class="dt">corstr =</span> <span class="st">&quot;independence&quot;</span>
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">tidy</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(term <span class="op">==</span><span class="st"> &quot;h_psi&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">psi =</span> psi) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(psi, estimate, p.value)
}

<span class="kw">compute_h_psi</span>(<span class="fl">3.446</span>)</code></pre>
<pre><code>## # A tibble: 1 x 3
##     psi estimate p.value
##   &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;
## 1  3.45 0.000286   0.974</code></pre>
<p>The way that we have to find the best value for <code>psi</code> is by brute force: we will search values of psi within a plausible range. Here, we’ll check from 2 to 5 by values of .1, meaning we will actually fit 31 models. Then, we’ll figure out which value of <code>psi</code> produces the <code>h_psi</code> closest to null. To fit the models, we’ll map the <code>compute_h_psi()</code> function to each value with <code>purrr::map_dfr()</code>. (The <code>map_dfr()</code> returns a data frame, so we can manipulate it with dplyr.)</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># search for h_psi for values of psi from 2 to 5 by .1</span>
psi_search &lt;-<span class="st"> </span><span class="kw">map_dfr</span>(<span class="kw">seq</span>(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dt">by =</span> <span class="fl">.1</span>), compute_h_psi)</code></pre>
<p>Because we didn’t search quite as finely as the authors, we get an answer that is close but not quite what they have. Had we searched more finely (e.g. <code>by = .001</code>), we would have done so but would need to fit thousands of models.</p>
<p>Since we want the estimate closest to 0, we’ll sort by the absolute value of <code>estimate</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">psi_search <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">abs</span>(estimate))</code></pre>
<pre><code>## # A tibble: 31 x 3
##      psi  estimate p.value
##    &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
##  1   3.5 -0.000735   0.934
##  2   3.4  0.00116    0.896
##  3   3.6 -0.00263    0.768
##  4   3.3  0.00304    0.729
##  5   3.7 -0.00453    0.612
##  6   3.2  0.00492    0.574
##  7   3.8 -0.00644    0.474
##  8   3.1  0.00679    0.435
##  9   3.9 -0.00836    0.356
## 10   3    0.00866    0.318
## # … with 21 more rows</code></pre>
<pre class="sourceCode r"><code class="sourceCode r">psi_est &lt;-<span class="st"> </span>psi_search <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(<span class="kw">abs</span>(estimate)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">slice</span>(<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>estimate, <span class="op">-</span>p.value)</code></pre>
<p>We can get the confidence intervals by filtering out p-values with that are lower than .05 (since we’re looking for statistical independence) and take the minimum and maximum values of the estimate.</p>
<pre class="sourceCode r"><code class="sourceCode r"><span class="co"># get minimum and maximum values that have p &gt;= .05 for confidence intervals</span>
psi_conf_int &lt;-<span class="st"> </span>psi_search <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(p.value <span class="op">&gt;=</span><span class="st"> </span><span class="fl">.05</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">slice</span>(<span class="kw">c</span>(<span class="dv">1</span>, <span class="kw">n</span>())) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(<span class="dt">type =</span> <span class="kw">c</span>(<span class="st">&quot;conf.low&quot;</span>, <span class="st">&quot;conf.high&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(type, psi) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">spread</span>(type, psi)

<span class="kw">bind_cols</span>(psi_est, psi_conf_int)</code></pre>
<pre><code>## # A tibble: 1 x 3
##     psi conf.high conf.low
##   &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
## 1   3.5       4.4      2.6</code></pre>
<p>The search ends up being linear (and, in fact, we can take a guess where the best <code>h_psi</code> will be based on the intercept of the regression line). Again, the closer we are to 0, the better.</p>
<pre class="sourceCode r"><code class="sourceCode r">psi_search <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> psi, <span class="dt">y =</span> estimate)) <span class="op">+</span><span class="st">       </span>
<span class="st">    </span><span class="kw">geom_hline</span>(<span class="dt">yintercept =</span> <span class="dv">0</span>, <span class="dt">col =</span> <span class="st">&quot;grey85&quot;</span>, <span class="dt">size =</span> <span class="fl">1.3</span>) <span class="op">+</span>
<span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">col =</span> <span class="st">&quot;#0072B2&quot;</span>, <span class="dt">size =</span> <span class="fl">1.2</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">shape =</span> <span class="dv">21</span>, <span class="dt">col =</span> <span class="st">&quot;white&quot;</span>, <span class="dt">fill =</span> <span class="st">&quot;#0072B2&quot;</span>, <span class="dt">size =</span> <span class="fl">2.5</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">    </span><span class="kw">theme_minimal</span>(<span class="dv">14</span>)</code></pre>
<p><img src="causal_inference_book_files/figure-html/unnamed-chunk-47-1.png" width="672" /></p>
<p>For some types of G-estimation models, we can use a closed-form estimator to predict <code>psi</code> using the censoring weights, outcome, treatment, and predicted treatment. First, we’ll calculate a model for <code>qsmk</code> (without <code>h_psi</code>) and then use these values to calculate <code>psi</code> using <code>psi_formula()</code>.</p>
<pre class="sourceCode r"><code class="sourceCode r">psi_formula &lt;-<span class="st"> </span><span class="cf">function</span>(weights, outcome, treatment, treatment_pred) {
  numerator &lt;-<span class="st"> </span>weights <span class="op">*</span><span class="st"> </span>outcome <span class="op">*</span><span class="st"> </span>(treatment <span class="op">-</span><span class="st"> </span>treatment_pred)
  denominator &lt;-<span class="st"> </span><span class="kw">sum</span>(weights <span class="op">*</span><span class="st"> </span>treatment <span class="op">*</span><span class="st"> </span>(treatment <span class="op">-</span><span class="st"> </span>treatment_pred), <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
  <span class="kw">sum</span>(numerator <span class="op">/</span><span class="st"> </span>denominator, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)
}

estimate_psi &lt;-<span class="st"> </span><span class="cf">function</span>(.data) {
  <span class="kw">glm</span>(
    qsmk <span class="op">~</span><span class="st"> </span>sex <span class="op">+</span><span class="st"> </span>race <span class="op">+</span><span class="st"> </span>age <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(age<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>education <span class="op">+</span><span class="st"> </span>
<span class="st">      </span>smokeintensity <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(smokeintensity<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">      </span>smokeyrs <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(smokeyrs<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>exercise <span class="op">+</span><span class="st"> </span>active <span class="op">+</span><span class="st"> </span>
<span class="st">      </span>wt71 <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(wt71<span class="op">^</span><span class="dv">2</span>), 
    <span class="dt">data =</span> .data, 
    <span class="dt">family =</span> <span class="kw">binomial</span>(),
    <span class="dt">weights =</span> cwts, 
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">augment</span>(<span class="dt">data =</span> .data, <span class="dt">type.predict =</span> <span class="st">&quot;response&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarize</span>(
      <span class="dt">psi =</span> <span class="kw">psi_formula</span>(
        <span class="dt">weights =</span> cwts, 
        <span class="dt">outcome =</span> wt82_<span class="dv">71</span>, 
        <span class="dt">treatment =</span> qsmk, 
        <span class="dt">treatment_pred =</span> .fitted
      )
    )
}

nhefs_complete <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>.fitted<span class="op">:-</span>.cooksd) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(censored <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">estimate_psi</span>()</code></pre>
<pre><code>## # A tibble: 1 x 1
##     psi
##   &lt;dbl&gt;
## 1  3.46</code></pre>
<p>As with other estimates, getting proper bootstraps involves writing a function to calculate the estimate using a re-sampled data set and then bootstrapping with the <code>boot</code> function.</p>
<pre class="sourceCode r"><code class="sourceCode r">bootstrap_psi &lt;-<span class="st"> </span><span class="cf">function</span>(data, indices) {
  <span class="co"># calculate psi for the re-sampled data set</span>
  <span class="kw">estimate_psi</span>(data[indices, ]) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">pull</span>(psi)
}

bootstrapped_psis &lt;-<span class="st"> </span>nhefs_complete <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>.fitted<span class="op">:-</span>.cooksd) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(censored <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">boot</span>(bootstrap_psi, <span class="dt">R =</span> <span class="dv">2000</span>)

bootstrapped_psis <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">tidy</span>(<span class="dt">conf.int =</span> <span class="ot">TRUE</span>, <span class="dt">conf.method =</span> <span class="st">&quot;bca&quot;</span>)</code></pre>
<pre><code>## # A tibble: 1 x 5
##   statistic     bias std.error conf.low conf.high
##       &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1      3.46 -0.00237     0.471     2.52      4.39</code></pre>
</div>
<div id="program-14.3" class="section level2">
<h2><span class="header-section-number">4.3</span> Program 14.3</h2>
<p>Searching for more than one estimate, as in a model where we’re interested in the effect of both quitting smoking and baseline smoking intensity, is more difficult because it requires searching in two dimensions. For this example, we’ll use the closed-form estimator. Essentially, it requires two matrices with different combinations of products of <code>qsmk</code>, <code>smokeintensity</code>, <code>wt82_71</code>, and the model residuals. We’ll write a function to create and solve these matrices for us and give us two parameter estimates.</p>
<pre class="sourceCode r"><code class="sourceCode r">estimate_psi2 &lt;-<span class="st"> </span><span class="cf">function</span>(.data) {
  <span class="kw">glm</span>(
    qsmk <span class="op">~</span><span class="st"> </span>sex <span class="op">+</span><span class="st"> </span>race <span class="op">+</span><span class="st"> </span>age <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(age<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>education <span class="op">+</span><span class="st"> </span>
<span class="st">      </span>smokeintensity <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(smokeintensity<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>
<span class="st">      </span>smokeyrs <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(smokeyrs<span class="op">^</span><span class="dv">2</span>) <span class="op">+</span><span class="st"> </span>exercise <span class="op">+</span><span class="st"> </span>active <span class="op">+</span><span class="st"> </span>
<span class="st">      </span>wt71 <span class="op">+</span><span class="st"> </span><span class="kw">I</span>(wt71<span class="op">^</span><span class="dv">2</span>), 
    <span class="dt">data =</span> .data, 
    <span class="dt">family =</span> <span class="kw">binomial</span>(),
    <span class="dt">weights =</span> cwts, 
  ) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">augment</span>(<span class="dt">data =</span> .data, <span class="dt">type.predict =</span> <span class="st">&quot;response&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">psi_formula2</span>()
}

solve_matrix &lt;-<span class="st"> </span><span class="cf">function</span>(.data, <span class="dt">.names =</span> <span class="kw">c</span>(<span class="st">&quot;psi1&quot;</span>, <span class="st">&quot;psi2&quot;</span>)) {
  cells &lt;-<span class="st"> </span>.data <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarise</span>(
      <span class="dt">a1 =</span> <span class="kw">sum</span>(qsmk <span class="op">*</span><span class="st"> </span>diff), 
      <span class="dt">a2 =</span> <span class="kw">sum</span>(qsmk <span class="op">*</span><span class="st"> </span>smokeintensity <span class="op">*</span><span class="st"> </span>diff), 
      <span class="dt">a3 =</span> <span class="kw">sum</span>(qsmk <span class="op">*</span><span class="st"> </span>smokeintensity <span class="op">*</span><span class="st"> </span>diff), 
      <span class="dt">a4 =</span> <span class="kw">sum</span>(qsmk <span class="op">*</span><span class="st"> </span>smokeintensity <span class="op">*</span><span class="st"> </span>smokeintensity <span class="op">*</span><span class="st"> </span>diff),
      <span class="dt">b1 =</span> <span class="kw">sum</span>(wt82_<span class="dv">71</span> <span class="op">*</span><span class="st"> </span>diff),
      <span class="dt">b2 =</span> <span class="kw">sum</span>(wt82_<span class="dv">71</span> <span class="op">*</span><span class="st"> </span>smokeintensity <span class="op">*</span><span class="st"> </span>diff)
    )
  
  a &lt;-<span class="st"> </span>cells <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(a1<span class="op">:</span>a4) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">matrix</span>(<span class="dv">2</span>, <span class="dv">2</span>)
  
  b &lt;-<span class="st"> </span>cells <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(b1<span class="op">:</span>b2) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">unlist</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">matrix</span>(<span class="dv">2</span>, <span class="dv">1</span>)
  
  <span class="kw">solve</span>(a, b) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">t</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">as_tibble</span>(<span class="dt">.name_repair =</span> <span class="st">&quot;minimal&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">set_names</span>(.names)
}

psi_formula2 &lt;-<span class="st"> </span><span class="cf">function</span>(.data) {
  .data <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(<span class="dt">diff =</span> (qsmk <span class="op">-</span><span class="st"> </span>.fitted) <span class="op">*</span><span class="st"> </span>cwts) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">drop_na</span>(wt82_<span class="dv">71</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">solve_matrix</span>()
}

nhefs_complete <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">select</span>(<span class="op">-</span>.fitted<span class="op">:-</span>.cooksd) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">filter</span>(censored <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">estimate_psi2</span>()</code></pre>
<pre><code>## # A tibble: 1 x 2
##    psi1   psi2
##   &lt;dbl&gt;  &lt;dbl&gt;
## 1  2.90 0.0287</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="chapter-13.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="chapter-15.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"google": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "google", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/malcolmbarrett/causal_inference_book/blob/master/chapter14.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
